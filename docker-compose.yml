version: '3.8'

services:
  # The Go BSV Broadcasting Server
  bsv-publisher:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bsv_akua_server
    restart: always
    stop_grace_period: 30s # Critical: allows train to finish current batch
    depends_on:
      - mongodb
    ports:
      - "8080:8080"
    environment:
      - MONGO_URI=mongodb://root:${MONGO_PASSWORD}@mongodb:27017
      - BSV_NETWORK=${BSV_NETWORK:-mainnet}
      - FUNDING_PRIVKEY=${FUNDING_PRIVKEY}
      - PUBLISHING_PRIVKEY=${PUBLISHING_PRIVKEY}
      - ARC_URL=${ARC_URL:-https://arc.gorillapool.io}
      - ARC_TOKEN=${ARC_TOKEN}
      - MIN_FEE_RATE=${MIN_FEE_RATE:-0.5}
      - TRAIN_INTERVAL=${TRAIN_INTERVAL:-3s}
      - TRAIN_MAX_BATCH=${TRAIN_MAX_BATCH:-1000}
      - TARGET_PUBLISHING_UTXOS=${TARGET_PUBLISHING_UTXOS:-50000}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    networks:
      - bsv-network
    volumes:
      - ./logs:/app/logs

  # MongoDB for UTXO Management
  mongodb:
    image: mongo:7
    container_name: bsv_akua_db
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
      - MONGO_INITDB_DATABASE=bsv_broadcaster
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - bsv-network
    command: mongod --wiredTigerCacheSizeGB 2

  # Mongo Express GUI (optional, for development)
  mongo-express:
    image: mongo-express:latest
    container_name: bsv_akua_gui
    restart: always
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=root
      - ME_CONFIG_MONGODB_ADMINPASSWORD=${MONGO_PASSWORD}
      - ME_CONFIG_MONGODB_URL=mongodb://root:${MONGO_PASSWORD}@mongodb:27017/
      - ME_CONFIG_BASICAUTH_USERNAME=${MONGO_EXPRESS_USER:-admin}
      - ME_CONFIG_BASICAUTH_PASSWORD=${MONGO_EXPRESS_PASSWORD:-admin}
    depends_on:
      - mongodb
    networks:
      - bsv-network
    profiles:
      - dev

  # Admin Portal Frontend
  admin-portal:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: bsv_admin_portal
    restart: always
    ports:
      - "3001:80"
    networks:
      - bsv-network
    depends_on:
      - bsv-publisher

networks:
  bsv-network:
    driver: bridge

volumes:
  mongo_data:
